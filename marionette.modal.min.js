(function(a,b){"use strict";"function"==typeof define&&define.amd?define(["backbone","underscore","marionette"],b):a.Marionette.Modal=b(a.Backbone,a._,a.Marionette)}).call(this,this,function(a,b,c){"use strict";var d={defaultEffect:"slideTop"},e={slideTop:"mn-modal_effect_slide-top",fade:"mn-modal_effect_fade"},f=a.Model.extend({defaults:{isActive:!1},isNew:function(){return!0}}),g=a.Collection.extend({model:f,initialize:function(){this.on("destroy",this.onDestroy)},getActive:function(){return this.findWhere({isActive:!0})},hasActive:function(){return this.some(function(a){return a.get("isActive")})},getGroup:function(a){var b=a.get("group");return void 0!==b?this.where({group:b}):[]},onDestroy:function(a){var b=this.getGroup(a);b.length>0&&this.remove(b),this.reactivate()},reactivate:function(){if(void 0!==this.lastActive&&void 0!==this.get(this.lastActive))return this.lastActive.set("isActive",!0),this;var a=this.last();void 0!==a&&a.set("isActive",!0)}}),h=c.LayoutView.extend({template:b.template('<div class="js-item-container"></div>'),events:{"click .js-submit:not(.js-disabled)":"onSubmit","click .js-reject":"onReject","click .js-next:not(.js-disabled)":"onNext","click .js-previous":"onPrevious"},className:function(){var a=d.defaultClass,b=this.model.get("effect")||d.defaultEffect,c="mn-modal__item "+e[b],f=this.model.get("className");return a&&(c+=" "+a),f&&(c+=" "+f),c},modelEvents:{"change:isActive":"onChangeActive",reject:"onReject",submit:"onSubmit",close:"closeModal"},regions:{contentRegion:".js-item-container"},onRender:function(){var a=this.model.get("View");this.contentRegion.show(new a),this.toggle(this.model.get("isActive"))},toggle:function(a){var c=this.el,f=this.model.get("effect")||d.defaultEffect,g=e[f]+"_shown";a?b.defer(function(){c.classList.add("mn-modal__item_shown",g)}):c.classList.remove("mn-modal__item_shown",g)},onChangeActive:function(a,b){this.toggle(b)},onSubmit:function(){var b=this,c=this.contentRegion.currentView.triggerMethod("submit");c!==!1&&a.$.when(c).done(function(){b.closeModal()})},onReject:function(){var a=this.contentRegion.currentView.triggerMethod("reject");a!==!1&&this.closeModal()},onNext:function(){var b=this,c=this.contentRegion.currentView.triggerMethod("next");if(c!==!1){var d=c.id,e=c.promise;e?a.$.when(e).done(function(){b._toggleModal(d)}):this._toggleModal(d)}},onPrevious:function(){var a=this.contentRegion.currentView.triggerMethod("previous");this._toggleModal(a)},_toggleModal:function(a){if(a!==!1){var b=this.model.collection.get(a);if(void 0===b)throw new c.Error({message:'modal dialog with id "'+a+'" not found',name:"ModalException"});this.model.set("isActive",!1),b.set("isActive",!0),this.model.collection.lastActive=b}},closeModal:function(){this.el.classList.remove("mn-modal__item_shown"),this.model.destroy()}}),i=c.CollectionView.extend({el:"#mn-modal",sort:!1,childView:h,toggle:function(a){return this.el.classList.toggle("mn-modal_shown",a)}}),j=function(){this.collection=new g,this.container=new i({collection:this.collection}),this.container.render(),this.listenTo(this.container,"add:child remove:child",this.toggleContainer)};return b.extend(j.prototype,a.Events,{add:function(a){var c=this;b.isArray(a)?a.forEach(function(a){c._add(a)}):this._add(a)},_add:function(a){a.isActive?(this.collection.lastActive=this.collection.getActive(),void 0!==this.collection.lastActive&&this.collection.lastActive.set("isActive",!1)):0===this.collection.length&&(a.isActive=!0),this.collection.add(a)},onReject:function(){var a=this.collection.getActive();void 0!==a&&a.trigger("reject")},onSubmit:function(){var a=this.collection.getActive();void 0!==a&&a.trigger("submit")},toggleContainer:function(){this.container.toggle(this.collection.length>0)},configure:function(a){a.EA&&this._resetEvents(a.EA),b.extend(d,a)},_resetEvents:function(a){d.EA&&this.stopListening(d.EA),this.listenTo(a,"submit",this.onSubmit),this.listenTo(a,"reject",this.onReject)},close:function(a){if(void 0!==a){var b=this.collection.get(a);void 0!==b&&b.trigger("close")}}}),new j});